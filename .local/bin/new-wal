#!/usr/bin/env bash

# Choose a random new wallpaper from wallpaper directory
new_bg=${HOME}/.local/share/img/$(ls ${HOME}/.local/share/img/ | shuf -n 1)

# Hackily "stop repainting" by taking a screenshot
# and displaying it full screen. This reduces flickering
# and syncs up all the distinct theme updates at the cost
# of apparent system lag.
scrot -z /tmp/wal-scrot.png
bspc rule -a feh -o state=fullscreen
feh /tmp/wal-scrot.png &
feh_pid=($!)

# Determine the new colour scheme
# and repaint shell, gtk2, polybar, emacs, dunst, etc.
wal -n -i ${new_bg} -o ${HOME}/.local/bin/wal-set &
pids+=($!)

# Set wallpaper
feh --bg-fill ${new_bg} &
pids+=($!)

# Wait for colour scheme and wallpaper to be set
wait ${pids[@]}

sleep 0.5  # polybar is slow to restart

# "Repaint screen"
kill $feh_pid
