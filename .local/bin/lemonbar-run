#!/bin/bash

source ${HOME}/.cache/wal/colors.sh

PANEL_FIFO="/tmp/panel-fifo"
PANEL_WM_NAME="lemonbar"

if [ -e "$PANEL_FIFO" ]; then
    rm "$PANEL_FIFO"
fi
mkfifo "$PANEL_FIFO"

clock () {
    while true; do
        echo "C"
        sleep 1
    done
}

music () {
    pactl subscribe
    while read -r line; do
        echo "M"
    done
}

# subscribe to event stream for window manager
bspc subscribe report > "$PANEL_FIFO" &

# subscribe to music event stream
music > "$PANEL_FIFO" &

# trigger updates every second of things without event streams (date, battery)
clock > "$PANEL_FIFO" &

screen_width=$(xdotool getdisplaygeometry --shell | \
                   awk -F "=" '$1 == "WIDTH" { print $2 }')

${HOME}/.local/bin/lemonbar-input < "$PANEL_FIFO" | lemonbar \
    -g $(( screen_width - 2 * 35))x40+35+35 \
    -o 1 \
    -f "FantasqueSansMono:size=10" \
    -o 0 \
    -f "LineaCustom:size=9" \
    -o 1 \
    -f "FantasqueSansMono:size=10:style=italic" \
    -B "${color7}" \
    -F "${color0}" \
    -a 0 \
    -n "${PANEL_WM_NAME}" \ &

xdo lower "$(xdo id -m -a ${PANEL_WM_NAME})"

wait
